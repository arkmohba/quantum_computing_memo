# 概要

下記のECサイト表示順最適化に関する論文のオマージュです。

https://www.frontiersin.org/articles/10.3389/fcomp.2019.00002/full

## 考え方

以下の2つの項が必要と解釈。

1. p_ijの項: 何かしらのクエリに対するランキングを作る項
2. f_iiの項：アイテム間の類似度を使う項

1.については何かしらの検索に対するランキングを流用する、2.についてはAIによる特徴ベクトルを使えば同じ定式化が利用できそうと考えました。

## 具体

AIの特徴ベクトルとして、業務的にDNNを使うことが多いので今回は画像の特徴ベクトルを利用しました。
また、ランキングとして類似度を利用します。

また、p_ijとf_iiを計算する特徴ベクトルが同じものだと、多様性がぱっとしないのでAIも2つ使っています。

* 1つはimagenetを学習した分類器で写っているものベースの特徴ベクトルになります。
  * もとのモデルはkerasからとってきました。
* もう1つはOpenVINOで公開されているモデルで模様ベースになります。
  * https://github.com/openvinotoolkit/open_model_zoo/blob/master/models/intel/image-retrieval-0001/description/image-retrieval-0001.md

OpenVINOを使う理由は、AI推論がアニーリングより遅くなってほしくないので速くしたかったのと、CPUで動かしたかったからです。実際に内部の実装でもOpenVINOを使用しています。

ランキングからp_ijを計算する方法として、シンプルに平均値が順位の分布を使うことにしました。大きな理由はないですが、整数に親和性がありそうということでポワソン分布を使用しています。

## 要素技術

* 画像特徴ベクトルの抽出
  * OpenVINO
* 特徴ベクトル検索
  * NGT(Yahoo! JAPAN)
  * 他にも色々ライブラリはあります。下記が参考になります。
    * https://github.com/erikbern/ann-benchmarks/
* データベース
  * sqlite
    * あまり深く考えず、楽に実装できるものを利用しています。
    * 今回、特徴ベクトルも登録しているので、他にDBの方が速い可能性はありますがアニーリングより遅くなることはないのではと予想しています。
* アニーラー
  * OpenJij
    * D-Wave等も使いたい気持ちはあったのですが、他の作り込みが大変だったのでローカルで閉じるもので済ませました。
    * D-Wave使うのであれば対して変更は必要ないです。（samplerだけ変えればよい）
    * pyquboベースです。

## ビルド

Dockerで提供しています。Windowsとかでもpythonが動けばなんとかなるかもしれません。


## 事前準備

docker-compose.ymlで画像検索する対象の画像フォルダを指定します。コンテナ内の/root/imagesに指定してください。

開発時はMS COCOのtrain2017などを使用しました。

## DB作成

下記コマンドで検索対処の画像の特徴ベクトル等を取り出しDBを作成します。
```
$ python3 add_vector2ngt.py -i /root/images/
```


## サンプル実行

下記コマンドで画像(xxx.jpg)に対して類似する画像のパス一覧をターミナルに出力します。

```
$ python3 search_sample.py -i xxx.jpg
```

## WebUI

flaskで簡単にウェブアプリを作っています。

```
$ python3 app.py
```

* 画面ではPOSTしたい画像や、使用する特徴ベクトル、検索する件数を指定します。
* 検索結果としてPOSTした画像と並べ替え前の画像列と並べ替え後の画像列が表示されます。
* ウェブ画面に返す画像のサムネイルがstatic/thums配下に生成されていきます。ディスクを食うようだったら削除してください。

## 感想

* 画像に対して日記や、商品情報などプラスアルファの情報がないとあまりおもしろみがない。
